- name: Create monitoring namespace
  community.kubernetes.k8s:
    api_version: v1
    kind: Namespace
    name: monitoring
    state: present

- name: Install kube-prometheus-stack
  ansible.builtin.command: >
    helm upgrade --install prometheus prometheus-community/kube-prometheus-stack
    --namespace monitoring
    --set prometheus.prometheusSpec.serviceMonitorSelectorNilUsesHelmValues=false
    --set grafana.enabled=true
  register: helm_install
  changed_when: "'deployed' in helm_install.stdout"
